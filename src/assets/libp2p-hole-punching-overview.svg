<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1569px" preserveAspectRatio="none" style="width:946px;height:1569px;" version="1.1" viewBox="0 0 946 1569" width="946px" zoomAndPan="magnify"><defs><filter height="300%" id="fwfix9rqcqyez" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#FFFFFF" filter="url(#fwfix9rqcqyez)" height="1555.8672" style="stroke: #000000; stroke-width: 1.0;" width="932.5" x="3" y="3"/><path d="M538,4 L538,12.2969 L528,22.2969 L3,22.2969 " fill="none" style="stroke: #000000; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="103" x="6" y="16.9951">Goal: The peer</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="11" x="113" y="16.9951">A</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="385" x="128" y="16.9951">establishes a direct connection to the non-dialable peer</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10" x="517" y="16.9951">B</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="4" x="527" y="16.9951">.</text><rect fill="#FFFFFF" filter="url(#fwfix9rqcqyez)" height="46.2656" style="stroke: #000000; stroke-width: 2.0;" width="390" x="487.5" y="261.5234"/><rect fill="#FFFFFF" filter="url(#fwfix9rqcqyez)" height="165.8672" style="stroke: #000000; stroke-width: 2.0;" width="431" x="487.5" y="321.7891"/><rect fill="#FFFFFF" height="74.2031" style="stroke: none; stroke-width: 1.0;" width="431" x="487.5" y="413.4531"/><rect fill="#FFFFFF" filter="url(#fwfix9rqcqyez)" height="152.7969" style="stroke: #000000; stroke-width: 2.0;" width="371.5" x="290.5" y="706.7188"/><rect fill="#FFFFFF" filter="url(#fwfix9rqcqyez)" height="261.3281" style="stroke: #000000; stroke-width: 2.0;" width="527.5" x="18" y="1238.2422"/><rect fill="#FFFFFF" filter="url(#fwfix9rqcqyez)" height="137.6641" style="stroke: #000000; stroke-width: 2.0;" width="507.5" x="28" y="1262.375"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="119" x2="119" y1="68.5938" y2="1516.5703"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="314.5" x2="314.5" y1="68.5938" y2="1516.5703"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="511.5" x2="511.5" y1="68.5938" y2="1516.5703"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="763.5" x2="763.5" y1="68.5938" y2="1516.5703"/><rect fill="#FEFECE" filter="url(#fwfix9rqcqyez)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="23" x="106" y="33.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="9" x="113" y="53.292">A</text><rect fill="#FEFECE" filter="url(#fwfix9rqcqyez)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="23" x="106" y="1515.5703"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="9" x="113" y="1535.5654">A</text><rect fill="#FEFECE" filter="url(#fwfix9rqcqyez)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="24" x="300.5" y="33.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="10" x="307.5" y="53.292">R</text><rect fill="#FEFECE" filter="url(#fwfix9rqcqyez)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="24" x="300.5" y="1515.5703"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="10" x="307.5" y="1535.5654">R</text><rect fill="#FEFECE" filter="url(#fwfix9rqcqyez)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="24" x="497.5" y="33.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="10" x="504.5" y="53.292">B</text><rect fill="#FEFECE" filter="url(#fwfix9rqcqyez)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="24" x="497.5" y="1515.5703"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="10" x="504.5" y="1535.5654">B</text><rect fill="#FEFECE" filter="url(#fwfix9rqcqyez)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="100" x="713.5" y="29.2969"/><rect fill="#FEFECE" filter="url(#fwfix9rqcqyez)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="100" x="709.5" y="33.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="86" x="716.5" y="53.292">Other_Peers</text><rect fill="#FEFECE" filter="url(#fwfix9rqcqyez)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="100" x="713.5" y="1515.5703"/><rect fill="#FEFECE" filter="url(#fwfix9rqcqyez)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="100" x="709.5" y="1519.5703"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="86" x="716.5" y="1539.5654">Other_Peers</text><rect fill="#EEEEEE" filter="url(#fwfix9rqcqyez)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="920.5" x="8" y="99.1602"/><line style="stroke: #000000; stroke-width: 1.0;" x1="8" x2="928.5" y1="99.1602" y2="99.1602"/><line style="stroke: #000000; stroke-width: 1.0;" x1="8" x2="928.5" y1="102.1602" y2="102.1602"/><rect fill="#EEEEEE" filter="url(#fwfix9rqcqyez)" height="23.1328" style="stroke: #000000; stroke-width: 2.0;" width="180" x="378.25" y="88.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="161" x="384.25" y="104.6606">Phase 1 - Preparation</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="0" x="550.25" y="104.6606"/><rect fill="#EEEEEE" filter="url(#fwfix9rqcqyez)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="920.5" x="8" y="157.4258"/><line style="stroke: #000000; stroke-width: 1.0;" x1="8" x2="928.5" y1="157.4258" y2="157.4258"/><line style="stroke: #000000; stroke-width: 1.0;" x1="8" x2="928.5" y1="160.4258" y2="160.4258"/><rect fill="#EEEEEE" filter="url(#fwfix9rqcqyez)" height="53.3984" style="stroke: #000000; stroke-width: 2.0;" width="307" x="314.75" y="131.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="129" x="402.75" y="147.7935">AutoNAT Protocol</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="0" x="469.75" y="162.9263"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="283" x="325.75" y="178.0591">B determining whether one is dialable</text><polygon fill="#A80036" points="751.5,242.5234,761.5,246.5234,751.5,250.5234,755.5,246.5234" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="511.5" x2="757.5" y1="246.5234" y2="246.5234"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="593.5" y="211.1919">DialRequest {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="189" x="547" y="226.3247">supposedly_public_addresses</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="633.5" y="241.4575">}</text><path d="M487.5,261.5234 L872.5,261.5234 L872.5,268.5234 L862.5,278.5234 L487.5,278.5234 L487.5,261.5234 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="46.2656" style="stroke: #000000; stroke-width: 2.0;" width="390" x="487.5" y="261.5234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="340" x="502.5" y="274.5903">For each provided supposedly public address</text><polygon fill="#A80036" points="522.5,295.7891,512.5,299.7891,522.5,303.7891,518.5,299.7891" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="516.5" x2="762.5" y1="299.7891" y2="299.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="625.5" y="294.7231">Dial</text><path d="M487.5,321.7891 L551.5,321.7891 L551.5,328.7891 L541.5,338.7891 L487.5,338.7891 L487.5,321.7891 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="165.8672" style="stroke: #000000; stroke-width: 2.0;" width="431" x="487.5" y="321.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="502.5" y="334.856">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="347" x="566.5" y="333.9995">[Dialable. No need for Hole Punching. Don't continue.]</text><polygon fill="#A80036" points="522.5,401.4531,512.5,405.4531,522.5,409.4531,518.5,405.4531" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="516.5" x2="762.5" y1="405.4531" y2="405.4531"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="590" y="354.9888">DialOutcome {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="628" y="370.1216">"Ok"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="579.5" y="385.2544">successful_address</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="633.5" y="400.3872">}</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="487.5" x2="918.5" y1="414.4531" y2="414.4531"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="310" x="492.5" y="424.6636">[Not dialable. Hole Punching needed. Continue.]</text><polygon fill="#A80036" points="522.5,475.6563,512.5,479.6563,522.5,483.6563,518.5,479.6563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="516.5" x2="762.5" y1="479.6563" y2="479.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="590" y="444.3247">DialOutcome {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="621" y="459.4575">"Error"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="633.5" y="474.5903">}</text><rect fill="#EEEEEE" filter="url(#fwfix9rqcqyez)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="920.5" x="8" y="530.3555"/><line style="stroke: #000000; stroke-width: 1.0;" x1="8" x2="928.5" y1="530.3555" y2="530.3555"/><line style="stroke: #000000; stroke-width: 1.0;" x1="8" x2="928.5" y1="533.3555" y2="533.3555"/><rect fill="#EEEEEE" filter="url(#fwfix9rqcqyez)" height="53.3984" style="stroke: #000000; stroke-width: 2.0;" width="288" x="324.25" y="504.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="135" x="399.75" y="520.7231">Kademlia Protocol</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="0" x="469.75" y="535.856"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="269" x="330.25" y="550.9888">B finding closest public Relay nodes</text><polygon fill="#A80036" points="751.5,585.1875,761.5,589.1875,751.5,593.1875,755.5,589.1875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="511.5" x2="757.5" y1="589.1875" y2="589.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216" x="529.5" y="584.1216">Find nodes closest to /B/'s Peer ID</text><polygon fill="#A80036" points="522.5,614.3203,512.5,618.3203,522.5,622.3203,518.5,618.3203" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="516.5" x2="762.5" y1="618.3203" y2="618.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="523.5" y="613.2544">List of nodes closest to /B/'s Peer ID</text><rect fill="#EEEEEE" filter="url(#fwfix9rqcqyez)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="920.5" x="8" y="662.0195"/><line style="stroke: #000000; stroke-width: 1.0;" x1="8" x2="928.5" y1="662.0195" y2="662.0195"/><line style="stroke: #000000; stroke-width: 1.0;" x1="8" x2="928.5" y1="665.0195" y2="665.0195"/><rect fill="#EEEEEE" filter="url(#fwfix9rqcqyez)" height="53.3984" style="stroke: #000000; stroke-width: 2.0;" width="416" x="260.25" y="636.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="180" x="377.25" y="652.3872">Circuit Relay v2 Protocol</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="0" x="469.75" y="667.52"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="397" x="266.25" y="682.6528">B listening for incoming connections via closest Relay</text><path d="M290.5,706.7188 L501.5,706.7188 L501.5,713.7188 L491.5,723.7188 L290.5,723.7188 L290.5,706.7188 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="152.7969" style="stroke: #000000; stroke-width: 2.0;" width="371.5" x="290.5" y="706.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="166" x="305.5" y="719.7856">For each closest Relay</text><polygon fill="#A80036" points="325.5,740.9844,315.5,744.9844,325.5,748.9844,321.5,744.9844" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="319.5" x2="510.5" y1="744.9844" y2="744.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="131" x="347.5" y="739.9185">Establish connection</text><polygon fill="#A80036" points="325.5,770.1172,315.5,774.1172,325.5,778.1172,321.5,774.1172" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="319.5" x2="510.5" y1="774.1172" y2="774.1172"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="349" y="769.0513">Request reservation</text><polygon fill="#A80036" points="499.5,799.25,509.5,803.25,499.5,807.25,503.5,803.25" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="314.5" x2="505.5" y1="803.25" y2="803.25"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="353" y="798.1841">Accept reservation</text><rect fill="#FBFB77" filter="url(#fwfix9rqcqyez)" height="38" style="stroke: #A80036; stroke-width: 1.0;" width="282" x="370" y="816.25"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="374" y="832.3169">Announce oneself as</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="374" y="847.4497">/&lt;RELAY_ADDR&gt;/p2p-circuit/&lt;B_PEER_ID&gt;</text><rect fill="#EEEEEE" filter="url(#fwfix9rqcqyez)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="920.5" x="8" y="887.082"/><line style="stroke: #000000; stroke-width: 1.0;" x1="8" x2="928.5" y1="887.082" y2="887.082"/><line style="stroke: #000000; stroke-width: 1.0;" x1="8" x2="928.5" y1="890.082" y2="890.082"/><rect fill="#EEEEEE" filter="url(#fwfix9rqcqyez)" height="23.1328" style="stroke: #000000; stroke-width: 2.0;" width="199" x="368.75" y="876.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="180" x="374.75" y="892.5825">Phase 2 - Hole Punching</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="0" x="559.75" y="892.5825"/><rect fill="#EEEEEE" filter="url(#fwfix9rqcqyez)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="920.5" x="8" y="945.3477"/><line style="stroke: #000000; stroke-width: 1.0;" x1="8" x2="928.5" y1="945.3477" y2="945.3477"/><line style="stroke: #000000; stroke-width: 1.0;" x1="8" x2="928.5" y1="948.3477" y2="948.3477"/><rect fill="#EEEEEE" filter="url(#fwfix9rqcqyez)" height="53.3984" style="stroke: #000000; stroke-width: 2.0;" width="281" x="327.75" y="919.6484"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="180" x="377.25" y="935.7153">Circuit Relay v2 Protocol</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="0" x="469.75" y="950.8481"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="262" x="333.75" y="965.981">A establish relayed connection to B</text><polygon fill="#A80036" points="302.5,1000.1797,312.5,1004.1797,302.5,1008.1797,306.5,1004.1797" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="119.5" x2="308.5" y1="1004.1797" y2="1004.1797"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="150.5" y="999.1138">Establish Connection</text><polygon fill="#A80036" points="302.5,1029.3125,312.5,1033.3125,302.5,1037.3125,306.5,1033.3125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="119.5" x2="308.5" y1="1033.3125" y2="1033.3125"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="139" y="1028.2466">Request connection to B</text><polygon fill="#A80036" points="499.5,1058.4453,509.5,1062.4453,499.5,1066.4453,503.5,1062.4453" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="314.5" x2="505.5" y1="1062.4453" y2="1062.4453"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="326.5" y="1057.3794">Request connection from A</text><polygon fill="#A80036" points="325.5,1087.5781,315.5,1091.5781,325.5,1095.5781,321.5,1091.5781" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="319.5" x2="510.5" y1="1091.5781" y2="1091.5781"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="171" x="327.5" y="1086.5122">Accept connection request</text><polygon fill="#A80036" points="130.5,1116.7109,120.5,1120.7109,130.5,1124.7109,126.5,1120.7109" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="124.5" x2="313.5" y1="1120.7109" y2="1120.7109"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="171" x="131.5" y="1115.645">Accept connection request</text><polygon fill="#A80036" points="130.5,1145.8438,120.5,1149.8438,130.5,1153.8438,126.5,1149.8438" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#A80036" points="499.5,1145.8438,509.5,1149.8438,499.5,1153.8438,503.5,1149.8438" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="124.5" x2="505.5" y1="1149.8438" y2="1149.8438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="237" x="197" y="1144.7778">Relayed Connection established</text><rect fill="#EEEEEE" filter="url(#fwfix9rqcqyez)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="920.5" x="8" y="1193.543"/><line style="stroke: #000000; stroke-width: 1.0;" x1="8" x2="928.5" y1="1193.543" y2="1193.543"/><line style="stroke: #000000; stroke-width: 1.0;" x1="8" x2="928.5" y1="1196.543" y2="1196.543"/><rect fill="#EEEEEE" filter="url(#fwfix9rqcqyez)" height="53.3984" style="stroke: #000000; stroke-width: 2.0;" width="452" x="242.25" y="1167.8438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="438" x="248.25" y="1183.9106">Direct Connection Upgrade through Relay (DCUtR) Protocol</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="0" x="469.75" y="1199.0435"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="174" x="377.75" y="1214.1763">A and B coordinate dial</text><path d="M18,1238.2422 L95,1238.2422 L95,1245.2422 L85,1255.2422 L18,1255.2422 L18,1238.2422 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="261.3281" style="stroke: #000000; stroke-width: 2.0;" width="527.5" x="18" y="1238.2422"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="32" x="33" y="1251.3091">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="235" x="110" y="1250.4526">[Until direct connection established]</text><path d="M28,1262.375 L241,1262.375 L241,1269.375 L231,1279.375 L28,1279.375 L28,1262.375 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="137.6641" style="stroke: #000000; stroke-width: 2.0;" width="507.5" x="28" y="1262.375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="168" x="43" y="1275.4419">Via relayed connection</text><polygon fill="#A80036" points="499.5,1296.6406,509.5,1300.6406,499.5,1304.6406,503.5,1300.6406" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="119.5" x2="505.5" y1="1300.6406" y2="1300.6406"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="242" y="1295.5747">Connect { addresses }</text><rect fill="#FBFB77" filter="url(#fwfix9rqcqyez)" height="23" style="stroke: #A80036; stroke-width: 1.0;" width="163" x="38" y="1313.6406"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="155" x="42" y="1329.7075">Measure round-trip time</text><polygon fill="#A80036" points="130.5,1358.9063,120.5,1362.9063,130.5,1366.9063,126.5,1362.9063" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="124.5" x2="510.5" y1="1362.9063" y2="1362.9063"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="242" y="1357.8403">Connect { addresses }</text><polygon fill="#A80036" points="499.5,1388.0391,509.5,1392.0391,499.5,1396.0391,503.5,1392.0391" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="119.5" x2="505.5" y1="1392.0391" y2="1392.0391"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="31" x="300" y="1386.9731">Sync</text><rect fill="#FBFB77" filter="url(#fwfix9rqcqyez)" height="53" style="stroke: #A80036; stroke-width: 1.0;" width="414" x="108" y="1412.0391"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="233" x="198.75" y="1428.106">Simultaneously establish connection</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="102" x="198.75" y="1443.2388">- A after 1/2 RTT</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="198.75" y="1458.3716">- B when receiving Connect</text><polygon fill="#A80036" points="130.5,1487.5703,120.5,1491.5703,130.5,1495.5703,126.5,1491.5703" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#A80036" points="499.5,1487.5703,509.5,1491.5703,499.5,1495.5703,503.5,1491.5703" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="124.5" x2="505.5" y1="1491.5703" y2="1491.5703"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="169.5" y="1486.5044">Attempt direct connection / Hole Punch</text><!--MD5=[ab4423f7a69dbeb70452e1bcac6d1dd3]
@startuml
participant A
participant R
participant B
collections Other_Peers

mainframe Goal: The peer **A** establishes a direct connection to the non-dialable peer **B**.

== __Phase 1 - Preparation__ ==

== AutoNAT Protocol\n\n B determining whether one is dialable ==

B -> Other_Peers: DialRequest {\n  supposedly_public_addresses\n}

group For each provided supposedly public address
Other_Peers -> B: Dial
end

alt Dialable. No need for Hole Punching. Don't continue.
    Other_Peers -> B: DialOutcome {\n  "Ok"\n  successful_address\n}
else Not dialable. Hole Punching needed. Continue.
    Other_Peers -> B: DialOutcome {\n  "Error"\n}
end

== Kademlia Protocol\n\nB finding closest public Relay nodes ==

B -> Other_Peers: Find nodes closest to /B/'s Peer ID
Other_Peers -> B: List of nodes closest to /B/'s Peer ID

== Circuit Relay v2 Protocol\n\nB listening for incoming connections via closest Relay ==

group For each closest Relay
  B -> R: Establish connection
  B -> R: Request reservation
  R -> B: Accept reservation
  rnote over B: Announce oneself as\n/<RELAY_ADDR>/p2p-circuit/<B_PEER_ID>
end

== __Phase 2 - Hole Punching__ ==

== Circuit Relay v2 Protocol\n\nA establish relayed connection to B ==

A -> R: Establish Connection
A -> R: Request connection to B
R -> B: Request connection from A
B -> R: Accept connection request
R -> A: Accept connection request

skinparam sequenceMessageAlign center

A <-> B: **Relayed Connection established**

== Direct Connection Upgrade through Relay (DCUtR) Protocol\n\nA and B coordinate dial ==

loop Until direct connection established
group Via relayed connection
A -> B: Connect { addresses }
rnote over A: Measure round-trip time
B -> A: Connect { addresses }
A -> B: Sync
end

rnote over A, B: Simultaneously establish connection\n- A after 1/2 RTT\n- B when receiving Connect
A <-> B: **Attempt direct connection / Hole Punch**
end

@enduml

PlantUML version 1.2020.02(Sun Mar 01 11:22:07 CET 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 11.0.13+8-post-Debian-1deb11u1
Operating System: Linux
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>