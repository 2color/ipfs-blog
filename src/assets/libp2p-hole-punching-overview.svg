<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1385px" preserveAspectRatio="none" style="width:1010px;height:1385px;" version="1.1" viewBox="0 0 1010 1385" width="1010px" zoomAndPan="magnify"><defs><filter height="300%" id="fe5jc3l65e40z" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#FFFFFF" filter="url(#fe5jc3l65e40z)" height="1371.6719" style="stroke: #000000; stroke-width: 1.0;" width="996.5" x="3" y="3"/><path d="M478,4 L478,12.2969 L468,22.2969 L3,22.2969 " fill="none" style="stroke: #000000; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="465" x="6" y="16.9951">Goal: Peer A establishes a direct connection to non-dialable peer B.</text><rect fill="#FFFFFF" filter="url(#fe5jc3l65e40z)" height="316.6641" style="stroke: #000000; stroke-width: 2.0;" width="476" x="487.5" y="128.7266"/><rect fill="#FFFFFF" filter="url(#fe5jc3l65e40z)" height="46.2656" style="stroke: #000000; stroke-width: 2.0;" width="390" x="497.5" y="212.2578"/><rect fill="#FFFFFF" filter="url(#fe5jc3l65e40z)" height="165.8672" style="stroke: #000000; stroke-width: 2.0;" width="431" x="497.5" y="272.5234"/><rect fill="#FFFFFF" height="74.2031" style="stroke: none; stroke-width: 1.0;" width="431" x="497.5" y="364.1875"/><rect fill="#FFFFFF" filter="url(#fe5jc3l65e40z)" height="75.3984" style="stroke: #000000; stroke-width: 2.0;" width="485" x="497.5" y="459.3906"/><rect fill="#FFFFFF" filter="url(#fe5jc3l65e40z)" height="179.9297" style="stroke: #000000; stroke-width: 2.0;" width="593" x="290.5" y="548.7891"/><rect fill="#FFFFFF" filter="url(#fe5jc3l65e40z)" height="104.5313" style="stroke: #000000; stroke-width: 2.0;" width="427" x="300.5" y="572.9219"/><rect fill="#FFFFFF" filter="url(#fe5jc3l65e40z)" height="223.0625" style="stroke: #000000; stroke-width: 2.0;" width="459.5" x="96" y="785.8516"/><rect fill="#FFFFFF" filter="url(#fe5jc3l65e40z)" height="133.6641" style="stroke: #000000; stroke-width: 2.0;" width="439.5" x="106" y="839.1172"/><rect fill="#FFFFFF" filter="url(#fe5jc3l65e40z)" height="292.4609" style="stroke: #000000; stroke-width: 2.0;" width="693" x="18" y="1022.9141"/><rect fill="#FFFFFF" filter="url(#fe5jc3l65e40z)" height="261.3281" style="stroke: #000000; stroke-width: 2.0;" width="527.5" x="28" y="1047.0469"/><rect fill="#FFFFFF" filter="url(#fe5jc3l65e40z)" height="137.6641" style="stroke: #000000; stroke-width: 2.0;" width="507.5" x="38" y="1071.1797"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="129" x2="129" y1="68.5938" y2="1332.375"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="324.5" x2="324.5" y1="68.5938" y2="1332.375"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="521.5" x2="521.5" y1="68.5938" y2="1332.375"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="819.5" x2="819.5" y1="68.5938" y2="1332.375"/><rect fill="#FEFECE" filter="url(#fe5jc3l65e40z)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="23" x="116" y="33.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="9" x="123" y="53.292">A</text><rect fill="#FEFECE" filter="url(#fe5jc3l65e40z)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="23" x="116" y="1331.375"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="9" x="123" y="1351.3701">A</text><rect fill="#FEFECE" filter="url(#fe5jc3l65e40z)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="24" x="310.5" y="33.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="10" x="317.5" y="53.292">R</text><rect fill="#FEFECE" filter="url(#fe5jc3l65e40z)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="24" x="310.5" y="1331.375"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="10" x="317.5" y="1351.3701">R</text><rect fill="#FEFECE" filter="url(#fe5jc3l65e40z)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="24" x="507.5" y="33.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="10" x="514.5" y="53.292">B</text><rect fill="#FEFECE" filter="url(#fe5jc3l65e40z)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="24" x="507.5" y="1331.375"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="10" x="514.5" y="1351.3701">B</text><rect fill="#FEFECE" filter="url(#fe5jc3l65e40z)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="100" x="769.5" y="29.2969"/><rect fill="#FEFECE" filter="url(#fe5jc3l65e40z)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="100" x="765.5" y="33.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="86" x="772.5" y="53.292">Other_Peers</text><rect fill="#FEFECE" filter="url(#fe5jc3l65e40z)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="100" x="769.5" y="1331.375"/><rect fill="#FEFECE" filter="url(#fe5jc3l65e40z)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="100" x="765.5" y="1335.375"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="86" x="772.5" y="1355.3701">Other_Peers</text><rect fill="#EEEEEE" filter="url(#fe5jc3l65e40z)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="984.5" x="8" y="99.1602"/><line style="stroke: #000000; stroke-width: 1.0;" x1="8" x2="992.5" y1="99.1602" y2="99.1602"/><line style="stroke: #000000; stroke-width: 1.0;" x1="8" x2="992.5" y1="102.1602" y2="102.1602"/><rect fill="#EEEEEE" filter="url(#fe5jc3l65e40z)" height="23.1328" style="stroke: #000000; stroke-width: 2.0;" width="180" x="410.25" y="88.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="161" x="416.25" y="104.6606">Phase 1 - Preparation</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="0" x="582.25" y="104.6606"/><path d="M487.5,128.7266 L958.5,128.7266 L958.5,135.7266 L948.5,145.7266 L487.5,145.7266 L487.5,128.7266 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="316.6641" style="stroke: #000000; stroke-width: 2.0;" width="476" x="487.5" y="128.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="426" x="502.5" y="141.7935">B determining whether it is dialable via AutoNAT protocol</text><polygon fill="#A80036" points="807.5,193.2578,817.5,197.2578,807.5,201.2578,811.5,197.2578" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="521.5" x2="813.5" y1="197.2578" y2="197.2578"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="528.5" y="161.9263">DialRequest {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="189" x="536.5" y="177.0591">supposedly_public_addresses</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="528.5" y="192.1919">}</text><path d="M497.5,212.2578 L882.5,212.2578 L882.5,219.2578 L872.5,229.2578 L497.5,229.2578 L497.5,212.2578 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="46.2656" style="stroke: #000000; stroke-width: 2.0;" width="390" x="497.5" y="212.2578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="340" x="512.5" y="225.3247">For each provided supposedly public address</text><polygon fill="#A80036" points="532.5,246.5234,522.5,250.5234,532.5,254.5234,528.5,250.5234" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="526.5" x2="818.5" y1="250.5234" y2="250.5234"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="538.5" y="245.4575">Dial</text><path d="M497.5,272.5234 L561.5,272.5234 L561.5,279.5234 L551.5,289.5234 L497.5,289.5234 L497.5,272.5234 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="165.8672" style="stroke: #000000; stroke-width: 2.0;" width="431" x="497.5" y="272.5234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="512.5" y="285.5903">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="347" x="576.5" y="284.7339">[Dialable. No need for Hole Punching. Don't continue.]</text><polygon fill="#A80036" points="532.5,352.1875,522.5,356.1875,532.5,360.1875,528.5,356.1875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="526.5" x2="818.5" y1="356.1875" y2="356.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="538.5" y="305.7231">DialOutcome {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="546.5" y="320.856">"Ok"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="546.5" y="335.9888">successful_address</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="538.5" y="351.1216">}</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="497.5" x2="928.5" y1="365.1875" y2="365.1875"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="310" x="502.5" y="375.3979">[Not dialable. Hole Punching needed. Continue.]</text><polygon fill="#A80036" points="532.5,426.3906,522.5,430.3906,532.5,434.3906,528.5,430.3906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="526.5" x2="818.5" y1="430.3906" y2="430.3906"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="538.5" y="395.0591">DialOutcome {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="546.5" y="410.1919">"Error"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="538.5" y="425.3247">}</text><path d="M497.5,459.3906 L977.5,459.3906 L977.5,466.3906 L967.5,476.3906 L497.5,476.3906 L497.5,459.3906 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="75.3984" style="stroke: #000000; stroke-width: 2.0;" width="485" x="497.5" y="459.3906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="435" x="512.5" y="472.4575">B finding closest public Relay nodes via Kademlia Protocol</text><polygon fill="#A80036" points="807.5,493.6563,817.5,497.6563,807.5,501.6563,811.5,497.6563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="521.5" x2="813.5" y1="497.6563" y2="497.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="528.5" y="492.5903">FindNodes(PEER_ID_B)</text><polygon fill="#A80036" points="532.5,522.7891,522.5,526.7891,532.5,530.7891,528.5,526.7891" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="526.5" x2="818.5" y1="526.7891" y2="526.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="236" x="538.5" y="521.7231">[ Public nodes closest to PEER_ID_B ]</text><path d="M290.5,548.7891 L732.5,548.7891 L732.5,555.7891 L722.5,565.7891 L290.5,565.7891 L290.5,548.7891 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="179.9297" style="stroke: #000000; stroke-width: 2.0;" width="593" x="290.5" y="548.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="397" x="305.5" y="561.856">B listening for incoming connections via closest Relay</text><path d="M300.5,572.9219 L722.5,572.9219 L722.5,579.9219 L712.5,589.9219 L300.5,589.9219 L300.5,572.9219 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="104.5313" style="stroke: #000000; stroke-width: 2.0;" width="427" x="300.5" y="572.9219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="377" x="315.5" y="585.9888">For each closest Relay via Circuit Relay v2 Protocol</text><polygon fill="#A80036" points="335.5,607.1875,325.5,611.1875,335.5,615.1875,331.5,611.1875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="329.5" x2="520.5" y1="611.1875" y2="611.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="131" x="341.5" y="606.1216">Establish connection</text><polygon fill="#A80036" points="335.5,636.3203,325.5,640.3203,335.5,644.3203,331.5,640.3203" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="329.5" x2="520.5" y1="640.3203" y2="640.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="341.5" y="635.2544">Request reservation</text><polygon fill="#A80036" points="509.5,665.4531,519.5,669.4531,509.5,673.4531,513.5,669.4531" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="324.5" x2="515.5" y1="669.4531" y2="669.4531"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="331.5" y="664.3872">Accept reservation</text><polygon fill="#A80036" points="807.5,716.7188,817.5,720.7188,807.5,724.7188,811.5,720.7188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="521.5" x2="813.5" y1="720.7188" y2="720.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="129" x="528.5" y="700.52">Advertise oneself as</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="528.5" y="715.6528">/&lt;RELAY_ADDR&gt;/p2p-circuit/&lt;PEER_ID_B&gt;</text><rect fill="#EEEEEE" filter="url(#fe5jc3l65e40z)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="984.5" x="8" y="756.2852"/><line style="stroke: #000000; stroke-width: 1.0;" x1="8" x2="992.5" y1="756.2852" y2="756.2852"/><line style="stroke: #000000; stroke-width: 1.0;" x1="8" x2="992.5" y1="759.2852" y2="759.2852"/><rect fill="#EEEEEE" filter="url(#fe5jc3l65e40z)" height="23.1328" style="stroke: #000000; stroke-width: 2.0;" width="199" x="400.75" y="745.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="180" x="406.75" y="761.7856">Phase 2 - Hole Punching</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="0" x="591.75" y="761.7856"/><path d="M96,785.8516 L403,785.8516 L403,792.8516 L393,802.8516 L96,802.8516 L96,785.8516 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="223.0625" style="stroke: #000000; stroke-width: 2.0;" width="459.5" x="96" y="785.8516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="262" x="111" y="798.9185">A establish relayed connection to B</text><polygon fill="#A80036" points="312.5,820.1172,322.5,824.1172,312.5,828.1172,316.5,824.1172" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="129.5" x2="318.5" y1="824.1172" y2="824.1172"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="136.5" y="819.0513">Establish Connection</text><path d="M106,839.1172 L331,839.1172 L331,846.1172 L321,856.1172 L106,856.1172 L106,839.1172 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="133.6641" style="stroke: #000000; stroke-width: 2.0;" width="439.5" x="106" y="839.1172"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="180" x="121" y="852.1841">Circuit Relay v2 Protocol</text><polygon fill="#A80036" points="312.5,873.3828,322.5,877.3828,312.5,881.3828,316.5,877.3828" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="129.5" x2="318.5" y1="877.3828" y2="877.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="136.5" y="872.3169">Request connection to B</text><polygon fill="#A80036" points="509.5,902.5156,519.5,906.5156,509.5,910.5156,513.5,906.5156" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="324.5" x2="515.5" y1="906.5156" y2="906.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="331.5" y="901.4497">Request connection from A</text><polygon fill="#A80036" points="335.5,931.6484,325.5,935.6484,335.5,939.6484,331.5,935.6484" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="329.5" x2="520.5" y1="935.6484" y2="935.6484"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="171" x="341.5" y="930.5825">Accept connection request</text><polygon fill="#A80036" points="140.5,960.7813,130.5,964.7813,140.5,968.7813,136.5,964.7813" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="134.5" x2="323.5" y1="964.7813" y2="964.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="171" x="146.5" y="959.7153">Accept connection request</text><polygon fill="#A80036" points="140.5,996.9141,130.5,1000.9141,140.5,1004.9141,136.5,1000.9141" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#A80036" points="509.5,996.9141,519.5,1000.9141,509.5,1004.9141,513.5,1000.9141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="134.5" x2="515.5" y1="1000.9141" y2="1000.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="237" x="146.5" y="995.8481">Relayed Connection established</text><path d="M18,1022.9141 L706,1022.9141 L706,1029.9141 L696,1039.9141 L18,1039.9141 L18,1022.9141 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="292.4609" style="stroke: #000000; stroke-width: 2.0;" width="693" x="18" y="1022.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="643" x="33" y="1035.981">A and B coordinate dial via Direct Connection Upgrade through Relay (DCUtR) Protocol</text><path d="M28,1047.0469 L105,1047.0469 L105,1054.0469 L95,1064.0469 L28,1064.0469 L28,1047.0469 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="261.3281" style="stroke: #000000; stroke-width: 2.0;" width="527.5" x="28" y="1047.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="32" x="43" y="1060.1138">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="235" x="120" y="1059.2573">[Until direct connection established]</text><path d="M38,1071.1797 L251,1071.1797 L251,1078.1797 L241,1088.1797 L38,1088.1797 L38,1071.1797 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="137.6641" style="stroke: #000000; stroke-width: 2.0;" width="507.5" x="38" y="1071.1797"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="168" x="53" y="1084.2466">Via relayed connection</text><polygon fill="#A80036" points="509.5,1105.4453,519.5,1109.4453,509.5,1113.4453,513.5,1109.4453" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="129.5" x2="515.5" y1="1109.4453" y2="1109.4453"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="136.5" y="1104.3794">Connect { addresses }</text><rect fill="#FBFB77" filter="url(#fe5jc3l65e40z)" height="23" style="stroke: #A80036; stroke-width: 1.0;" width="163" x="48" y="1122.4453"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="155" x="52" y="1138.5122">Measure round-trip time</text><polygon fill="#A80036" points="140.5,1167.7109,130.5,1171.7109,140.5,1175.7109,136.5,1171.7109" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="134.5" x2="520.5" y1="1171.7109" y2="1171.7109"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="146.5" y="1166.645">Connect { addresses }</text><polygon fill="#A80036" points="509.5,1196.8438,519.5,1200.8438,509.5,1204.8438,513.5,1200.8438" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="129.5" x2="515.5" y1="1200.8438" y2="1200.8438"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="31" x="136.5" y="1195.7778">Sync</text><rect fill="#FBFB77" filter="url(#fe5jc3l65e40z)" height="53" style="stroke: #A80036; stroke-width: 1.0;" width="414" x="118" y="1220.8438"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="233" x="208.75" y="1236.9106">Simultaneously establish connection</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="102" x="208.75" y="1252.0435">- A after 1/2 RTT</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="208.75" y="1267.1763">- B when receiving Connect</text><polygon fill="#A80036" points="140.5,1296.375,130.5,1300.375,140.5,1304.375,136.5,1300.375" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#A80036" points="509.5,1296.375,519.5,1300.375,509.5,1304.375,513.5,1300.375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="134.5" x2="515.5" y1="1300.375" y2="1300.375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="146.5" y="1295.3091">Attempt direct connection / Hole Punch</text><!--MD5=[598e26f0083d0e941b078a807fd8c04b]
@startuml
participant A
participant R
participant B
collections Other_Peers

mainframe Goal: Peer A establishes a direct connection to non-dialable peer B.

== __Phase 1 - Preparation__ ==

group B determining whether it is dialable via AutoNAT protocol
        B -> Other_Peers: DialRequest {\n  supposedly_public_addresses\n}
        group For each provided supposedly public address
                Other_Peers -> B: Dial
        end
        alt Dialable. No need for Hole Punching. Don't continue.
                Other_Peers -> B: DialOutcome {\n  "Ok"\n  successful_address\n}
        else Not dialable. Hole Punching needed. Continue.
                Other_Peers -> B: DialOutcome {\n  "Error"\n}
        end
end

group B finding closest public Relay nodes via Kademlia Protocol
        B -> Other_Peers: FindNodes(PEER_ID_B) 
        Other_Peers -> B: [ Public nodes closest to PEER_ID_B ]
end

group B listening for incoming connections via closest Relay
        group For each closest Relay via Circuit Relay v2 Protocol
                B -> R: Establish connection
                B -> R: Request reservation
                R -> B: Accept reservation
        end
        B -> Other_Peers: Advertise oneself as\n/<RELAY_ADDR>/p2p-circuit/<PEER_ID_B>
end

== __Phase 2 - Hole Punching__ ==

group A establish relayed connection to B

        A -> R: Establish Connection
        group Circuit Relay v2 Protocol
                A -> R: Request connection to B
                R -> B: Request connection from A
                B -> R: Accept connection request
                R -> A: Accept connection request
        end

        A <-> B: **Relayed Connection established**

end

group A and B coordinate dial via Direct Connection Upgrade through Relay (DCUtR) Protocol
        loop Until direct connection established
                group Via relayed connection
                        A -> B: Connect { addresses }
                        rnote over A: Measure round-trip time
                        B -> A: Connect { addresses }
                        A -> B: Sync
                end
                rnote over A, B: Simultaneously establish connection\n- A after 1/2 RTT\n- B when receiving Connect
                A <-> B: **Attempt direct connection / Hole Punch**
        end
end

@enduml

PlantUML version 1.2020.02(Sun Mar 01 11:22:07 CET 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 11.0.14+9-post-Debian-1deb11u1
Operating System: Linux
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>